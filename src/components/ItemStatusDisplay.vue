<!--
Nextcloud - Inventory

@author Raimund Schlüßler
@copyright 2019 Raimund Schlüßler <raimund.schluessler@mailbox.org>

This library is free software; you can redistribute it and/or
modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
License as published by the Free Software Foundation; either
version 3 of the License, or any later version.

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU AFFERO GENERAL PUBLIC LICENSE for more details.

You should have received a copy of the GNU Affero General Public
License along with this library.  If not, see <http://www.gnu.org/licenses/>.

-->

<template>
	<Actions v-if="status" :disabled="isDisabled">
		<ActionButton :disabled="isDisabled" :class="[`status--${status.status} full`]" @click="statusClicked">
			<template slot="icon">
				<AlertCircleOutline :size="24" class="status--error status--unsynced" />
				<Check :size="24" class="status--success" />
				<Loading :size="24" class="status--sync" />
				<SyncAlert :size="24" class="status--conflict" />
			</template>
			{{ status.message }}
		</ActionButton>
	</Actions>
</template>

<script>
import Actions from '@nextcloud/vue/dist/Components/Actions'
import ActionButton from '@nextcloud/vue/dist/Components/ActionButton'

import AlertCircleOutline from 'vue-material-design-icons/AlertCircleOutline.vue'
import Check from 'vue-material-design-icons/Check.vue'
import Loading from 'vue-material-design-icons/Loading.vue'
import SyncAlert from 'vue-material-design-icons/SyncAlert.vue'

export default {
	name: 'ItemStatusDisplay',
	components: {
		Actions,
		ActionButton,
		AlertCircleOutline,
		Check,
		Loading,
		SyncAlert,
	},
	props: {
		status: {
			type: Object,
			default: null,
		},
	},
	data() {
		return {
			resetStatusTimeout: null,
		}
	},
	computed: {
		isDisabled() {
			return this.status.status !== 'conflict'
		},
	},
	watch: {
		status(newStatus) {
			this.checkTimeout(newStatus)
		},
	},
	mounted() {
		this.checkTimeout(this.status)
	},
	methods: {
		statusClicked() {
			this.$emit('statusClicked')
		},
		checkTimeout(newStatus) {
			if (newStatus) {
				if (this.resetStatusTimeout) {
					clearTimeout(this.resetStatusTimeout)
				}
				if (newStatus.status === 'success') {
					this.resetStatusTimeout = setTimeout(
						() => {
							this.$emit('resetStatus')
						}, 5000
					)
				}
			}
		},
	},
}
</script>

<style lang="scss" scoped>
.action-item {
	&:disabled.full {
		opacity: 1 !important;
	}
	.material-design-icon {
		display: none;
	}
	&.status {
		&--error {
			color: var(--color-error);

			.status--error {
				display: flex;
			}
		}
		&--unsynced {
			color: var(--color-warning);

			.status--unsynced {
				display: flex;
			}
		}
		&--success {
			color: var(--color-success);

			.status--success {
				display: flex;
			}
		}
		&--sync svg,
		&--conflict svg {
			animation-iteration-count: infinite;
			animation-duration: 1s;
		}
		&--sync {
			.status--sync {
				display: flex;
			}
			svg {
				animation-name: spin;
			}
		}
		&--conflict {
			.status--conflict {
				display: flex;
			}
			svg {
				animation-name: pulse;
				border-radius: 50%;
			}
		}
	}
}
@keyframes spin {
	0% {
		transform: rotate(0deg);
	}
	100% {
		transform: rotate(360deg);
	}
}
@keyframes pulse {
	0% {
		box-shadow: 0 0 0 0 rgba(50, 50, 50, .4);
	}
	70% {
		box-shadow: 0 0 0 10px rgba(50, 50, 50, 0);
	}
	100% {
		box-shadow: 0 0 0 0 rgba(50, 50, 50, 0);
	}
}
</style>
